---
# The bare domain name which represents your Matrix identity.
# Matrix user ids for your server will be of the form (`@user:<matrix-domain>`).
#
# Note: this playbook does not touch the server referenced here.
# Installation happens on another server ("matrix.<matrix-domain>").
#
# If you've deployed using the wrong domain, you'll have to run the Uninstalling step,
# because you can't change the Domain after deployment.
#
# Example value: example.com
matrix_domain: '{{ MATRIX_DOMAIN }}'

matrix_server_fqn_matrix: '{{ SUBDOMAIN|default('synapse', true) }}.{{ MATRIX_DOMAIN }}'

# The Matrix homeserver software to install.
# See `roles/matrix-base/defaults/main.yml` for valid options.
matrix_homeserver_implementation: synapse

# A secret used as a base, for generating various other secrets.
# You can put any string here, but generating a strong one is preferred (e.g. `pwgen -s 64 1`).
matrix_homeserver_generic_secret_key: '{{ GENERIC_SECRET_KEY }}'

# This is something which is provided to Let's Encrypt when retrieving SSL certificates for domains.
#
# In case SSL renewal fails at some point, you'll also get an email notification there.
#
# If you decide to use another method for managing SSL certificates (different than the default Let's Encrypt),
# you won't be required to define this variable (see `docs/configuring-playbook-ssl-certificates.md`).
#
# Example value: someone@example.com
matrix_ssl_lets_encrypt_support_email: 'dservices+matrix@decentraland.org'

# A Postgres password to use for the superuser Postgres user (called `matrix` by default).
#
# The playbook creates additional Postgres users and databases (one for each enabled service)
# using this superuser account.
matrix_postgres_connection_password: '{{ POSTGRES_PASSWORD }}'

matrix_ssl_retrieval_method: none

matrix_synapse_container_client_api_host_bind_port: '127.0.0.1:8008'

matrix_synapse_workers_enabled: true

matrix_nginx_proxy_https_enabled: false


matrix_client_element_enabled: false
{% set use_presence = USE_PRESENCE|default('false') in ['true'] %}
matrix_synapse_presence_enabled: {{ use_presence }}

{%- set enable_open_registration = ENABLE_OPEN_REGISTRATION|default('false') in ['true'] -%}
{% if enable_open_registration %}
matrix_synapse_enable_registration: true
{% endif %}
{% if ENV not in ['prd'] %}
matrix_synapse_log_level: 'DEBUG'
# Config to support Romeo and Juliet benchmark and testing tools (429 - too many requests):
matrix_synapse_rc_registration:
  per_second: 5
  burst_count: 300

matrix_synapse_rc_login:
  address:
    per_second: 5
    burst_count: 1000
  account:
    per_second: 5
    burst_count: 300
  failed_attempts:
    per_second: 5
    burst_count: 300

matrix_synamse_rc_joins:
  local:
    per_second: 5
    burst_count: 1000
  remote:
    per_second: 5
    burst_count: 1000

matrix_synapse_rc_message:
  per_second: 5
  burst_count: 1000
{% endif %}
# Metrics/Stats
matrix_prometheus_enabled: true
matrix_prometheus_node_exporter_enabled: true

matrix_nginx_proxy_proxy_synapse_metrics: true

matrix_grafana_enabled: true
matrix_grafana_anonymous_access: true

{%- set use_external_db = USE_EXTERNAL_DB|default('false') in ['true'] -%}
{% if use_external_db %}

# External DB
matrix_postgres_enabled: false

# Rewire Synapse to use external Postgres server
matrix_synapse_database_host: '{{POSTGRES_HOST}}'
matrix_synapse_database_user: '{{POSTGRES_USER}}'
matrix_synapse_database_password: '{{POSTGRES_PASSWORD}}'
matrix_synapse_database_database: '{{POSTGRES_DATABASE}}'
{% endif %}

matrix_synapse_workers_enabled_list:
  - { type: generic_worker, instanceId: 'initial-sync-1', port: 18111, metrics_port: 19111 }
  - { type: generic_worker, instanceId: 'initial-sync-2', port: 18119, metrics_port: 19119 }
  - { type: generic_worker, instanceId: 'sync-1', port: 18112, metrics_port: 19112 }
  - { type: generic_worker, instanceId: 'sync-2', port: 18118, metrics_port: 19118 }
  - { type: generic_worker, instanceId: 'client-1', port: 18113, metrics_port: 19113 }
  - { type: generic_worker, instanceId: 'client-2', port: 18120, metrics_port: 19120 }
  - { type: generic_worker, instanceId: 'event-persister-1', port: 18114, metrics_port: 19114 }
  - { type: generic_worker, instanceId: 'event-persister-2', port: 18115, metrics_port: 19115 }
  - { type: generic_worker, instanceId: 'presence-worker', port: 18116, metrics_port: 19116 }
  - { type: generic_worker, instanceId: 'background-worker', port: 18117, metrics_port: 19117 }
  - { type: pusher, instanceId: 'pusher', port: 0, metrics_port: 19200 }
  - { type: frontend_proxy, instanceId: 'frontend-proxy', port: 18771, metrics_port: 19200 }

{% set use_decentraland_password_provider = USE_DECENTRALAND_PASSWORD_PROVIDER|default('false') in ['true'] %}
use_decentraland_password_provider: {{ use_decentraland_password_provider }}
# Decentraland Password Provider

matrix_synapse_configuration_extension_yaml: |
  database:
    args:
      cp_min: 5
      cp_max: 35
  instance_map:
    event-persister-1:
      host: matrix-synapse-worker-event-persister-1
      port: 18114
    event-persister-2:
      host: matrix-synapse-worker-event-persister-2
      port: 18115
    presence-worker:
      host: matrix-synapse-worker-presence-worker
      port: 18116
    background-worker:
      host: matrix-synapse-worker-background-worker
      port: 18117
  stream_writers:
    events:
      - event-persister-2
      - event-persister-1
    presence: presence-worker
  run_background_tasks_on: background-worker

{% if use_decentraland_password_provider %}
  # Decentraland password auth provider module
  password_providers:
    - module: decentraland_password_auth_provider.DecentralandPasswordAuthProvider
      config:
        enabled: true
        trusted_servers:
          - https://peer.decentraland.org/lambdas
          - https://peer-ec1.decentraland.org/lambdas
          - https://peer-wc1.decentraland.org/lambdas
          - https://peer-eu1.decentraland.org/lambdas
          - https://peer-ap1.decentraland.org/lambdas
          - https://interconnected.online/lambdas

{% endif %}

# To enable the metrics endpoint bearer token
matrix_nginx_proxy_proxy_synapse_metrics_basic_auth_enabled: true
matrix_nginx_proxy_proxy_synapse_metrics_basic_auth_key: {{ METRICS_BEARER_TOKEN }}
matrix_nginx_proxy_worker_connections: {{ NGINX_PROXY_WORKER_CONNECTIONS }}

{% set use_prometheus_postgres_exporter = USE_PROMETHEUS_POSTGRES_EXPORTER|default('false') in ['true'] %}
{% if use_prometheus_postgres_exporter %}
# Prometheus exporter for Postgres
matrix_prometheus_postgres_exporter_enabled: true

matrix_prometheus_postgres_exporter_database_username: '{{PROMETHEUS_EXPORTER_POSTGRES_USER}}'
matrix_prometheus_postgres_exporter_database_password: '{{PROMETHEUS_EXPORTER_POSTGRES_PASSWORD}}'
{% endif %}

matrix_postgres_process_extra_arguments: [
  "-c 'max_connections={{ POSTGRES_MAX_CONNECTIONS }}'"
]

matrix_env: {{ ENV }}

{% set use_worker_affinity_value = USE_WORKER_AFFINITY|default('false') in ['true'] %}
use_worker_affinity: {{ use_worker_affinity_value }}

{%- set use_external_redis = USE_ELASTI_CACHE|default('false') in ['true'] -%}
{% if use_external_redis %}
matrix_redis_enabled: false
matrix_synapse_redis_enabled: true
matrix_synapse_redis_host: {{ REDIS_HOST }}
matrix_synapse_redis_port: {{ REDIS_PORT }}
{% endif %}

docker_username: {{ DOCKER_USERNAME }}
docker_password: {{ DOCKER_PASSWORD }}

matrix_nginx_proxy_access_log_enabled: false

# We need the identity service as it's used for user directory searches.
matrix_ma1sd_enabled: true

# Disabling this will prevent email-notifications and other such things from working.
matrix_mailer_enabled: false

# You can also disable this to save more RAM,
# at the expense of audio/video calls being unreliable.
matrix_coturn_enabled: false

matrix_nginx_proxy_proxy_grafana_enabled: true

matrix_nginx_proxy_proxy_synapse_additional_server_configuration_blocks:
  - 'location /_synapse/node-exporter/ {
  resolver 127.0.0.11 valid=5s;
  proxy_pass http://matrix-prometheus-node-exporter:9100/;
  auth_basic "protected";
  auth_basic_user_file /nginx-data/matrix-synapse-metrics-htpasswd;
  }'

# Isolate matrix homerserver
matrix_synapse_federation_enabled: false

# Cache factors per type
